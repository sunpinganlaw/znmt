<!DOCTYPE html>
<html>
<head>
    <title>设备故障报警信息</title>
    <base href="${base}/">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
    <meta http-equiv="description" content="this is my page">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <#include "/include/common.html"/>
</head>
<body class="easyui-layout" data-options="fit:true" style="width: 100%;">
<div id="centerDiv" data-options="region:'center'" style="width: 82%;overflow: hidden">
    <div id="tb">
        <label for="beginTime">开始时间：</label>
        <input class="easyui-datebox" id="beginTime" style="width:120px">
        <label for="endTime">结束时间：</label>
        <input class="easyui-datebox" id="endTime" style="width:120px">
        <label for="errorConfirm">故障状态</label>
        <select id="errorConfirm" name="errorConfirm" class="easyui-combobox"
                data-options="value:'0',required:true,panelHeight:'auto'" style="width:100px;">
            <option value="">全部</option>
            <option selected value="0">未处理</option>
            <option value="1">已处理</option>
        </select>
        <label for="machineCode">设备名称：</label>
        <input id="machineCode" name="machineCode" class="easyui-combobox" style="width:120px;"
               data-options="valueField:'id',textField:'name',panelHeight:'auto',url:'${base}/business/tool/getComboboxOpt/DEVICE_INFO'"/>
        <span style="margin-left:0%;"/>
        <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-search" onclick="qryErrorSpec()">查询</a>
    </div>
    <table id="deviceErrDg" style="height: 100%;width:100%"></table>
</div>
<div data-options="region:'east',title:'扩展信息',split:true" style="width:18%;">
    <div id="" class="easyui-panel" title="关键指标" style="width:100%;height:258px;padding:0px;"
         data-options="fit:false">
        <table id="mcmzxx" class="easyui-datagrid"
               data-options="method:'get',border:true,singleSelect:true,fitColumns:true,showHeader:true">
            <thead>
            <tr>
                <th data-options="field:'key',width:70,align:'center'">指标</th>
                <th data-options="field:'dayVal',width:40,align:'center'">今日</th>
                <th data-options="field:'monthVal',width:40,align:'center'">本月</th>
                <th data-options="field:'yearVal',width:40,align:'center'">本年</th>
            </tr>
            </thead>
        </table>
    </div>
    <div id="p" class="easyui-panel" title="" data-options="fit:false"
         style="width:100%;height:735px;padding:0px;">
        <div class="easyui-tabs" style="width:100%;height:auto">
            <div title="实时信息（高）&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
                 style="padding:0;" data-options="tabWidth:152">
                <table id="dynamicInfoDg1" class="easyui-datagrid" width="300px"
                       data-options="method:'get',border:true,singleSelect:true,fitColumns:true,url:'${base}/business/monitor/deviceBroadList/1',showHeader:false">
                    <thead>
                    <tr>
                        <th data-options="field:'broadTime',width:45,align:'left'">时间</th>
                        <th data-options="field:'broadDec',width:55,align:'left'">信息</th>
                    </tr>
                    </thead>
                </table>
            </div>
            <div title="实时信息（中）&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
                 style="padding:0px;height: 20px;width: 40px" data-options="tabWidth:152">
                <table id="dynamicInfoDg2" class="easyui-datagrid" width="300px"
                       data-options="method:'get',border:true,singleSelect:true,fitColumns:true,url:'${base}/business/monitor/deviceBroadList/2',showHeader:false">
                    <thead>
                    <tr>
                        <th data-options="field:'broadTime',width:45,align:'left'">时间</th>
                        <th data-options="field:'broadDec',width:55,align:'left'">信息</th>
                    </tr>
                    </thead>
                </table>
            </div>
            <div title="实时信息（低）&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
                 style="padding:0px;height: 20px;width: 40px" data-options="tabWidth:152">
                <table id="dynamicInfoDg3" class="easyui-datagrid" width="300px"
                       data-options="method:'get',border:true,singleSelect:true,fitColumns:true,url:'${base}/business/monitor/deviceBroadList/3',showHeader:false">
                    <thead>
                    <tr>
                        <th data-options="field:'broadTime',width:45,align:'left'">时间</th>
                        <th data-options="field:'broadDec',width:55,align:'left'">信息</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="deviceErrDetailWin"></div>
</body>
</html>
<script type="text/javascript">
    $deviceErrDg = $("#deviceErrDg");
    var deviceIp;
    var machineCode;
    var flowId;

    $(function () {
        var startTime = getDay(-2);
        var endTime = getDay(0);
        var paramO = new Object();

        paramO.search_beginTime = startTime;
        paramO.search_endTime = endTime;
        paramO.search_errorConfirm = '0';
        $("#centerDiv").height($(this).height());
        $deviceErrDg.datagrid({
            url: '${base}/business/monitor/deviceErrListView',
            fitColumns: true,
            animate: true,
            border: true,
            //height: $(this).height() -$("#tb").height()-5,
            //width: $(this).width() - 5,
            idField: 'errorRecId',
            singleSelect: true,
            rownumbers: true,
            pagination: true,
            pagenumber: true,
            pageSize: 15,
            pageList: [15, 30, 45],
            queryParams: paramO,
            columns: [
                [
                    //{field: 'errorRecId', title: '故障信息ID', align: 'center', width: 30},
                    {field: 'errorTime', title: '故障时间', align: 'center', width: 30},
                    {field: 'errorDec', title: '故障描述', align: 'center', width: 80},
                    {field: 'errorConfirm', title: '故障状态', align: 'center', width: 30},
                    {field: 'bak', title: '处理详情', align: 'center', width: 50},
                    {field: 'confirmOp', title: '处理人', align: 'center'}
                ]
            ],
            onDblClickRow: function (rowIndex, rowData) {
                deviceIp = rowData.deviceIp;
                machineCode = rowData.machineCode;
                flowId = rowData.flowId;
                viewDeviceErrDetail(rowData.errorRecId);
            },
            toolbar: '#tb'
        });
    });


    function getDay(day) {
        var today = new Date();
        var targetday_milliseconds = today.getTime() + 1000 * 60 * 60 * 24 * day;
        today.setTime(targetday_milliseconds); //注意，这行是关键代码
        var tYear = today.getFullYear();
        var tMonth = today.getMonth();
        var tDate = today.getDate();
        tMonth = doHandleMonth(tMonth + 1);
        tDate = doHandleMonth(tDate);
        return tYear + "-" + tMonth + "-" + tDate;
    }
    function doHandleMonth(month) {
        var m = month;
        if (month.toString().length == 1) {
            m = "0" + month;
        }
        return m;
    }
    function viewDeviceErrDetail(recId) {
        var win = $('#deviceErrDetailWin').window({
            modal: true,
            title: '故障报警信息详情及处理',
            width: $(window).width() - 100,
            height: $(window).height() - 50,
            collapsible: false,
            minimizable: false,
            maximizable: true,
            href: '${base}/business/monitor/deviceErrDetail/' + recId,
            onClose: function () {
                $("#deviceErrDg").datagrid('load');
            }
        });
    }
    function qryErrorSpec() {
        var paramO = new Object();
        var beginTime = $("#beginTime").datebox("getValue");
        var endTime = $("#endTime").datebox("getValue");
        var machineCode = $("#machineCode").combobox("getValue");
        var errorConfirm = $("#errorConfirm").combobox("getValue");
        if (beginTime != null && beginTime != "" && beginTime.length > 0) {
            paramO.search_beginTime = beginTime;
        }
        if (endTime != null && endTime != "" && endTime.length > 0) {
            paramO.search_endTime = endTime;
        }
        if (machineCode != null && machineCode != "" && machineCode.length > 0) {
            paramO.search_machineCode = machineCode;
        }
        if (errorConfirm != null && errorConfirm != "" && errorConfirm.length > 0) {
            paramO.search_errorConfirm = errorConfirm;
        }
        $deviceErrDg.datagrid("load", paramO);
    }
    //每过10秒刷新设备动态信息
    window.setInterval(function () {
        $("#deviceErrDg").datagrid('load', getCurrentQryParam());
    }, 10 * 1000);
    /**
     * 拼接查询条件
     * @returns {{}}
     */
    function getCurrentQryParam() {
        var qryParam = {};
        var beginTime = $("#beginTime").datebox("getValue");
        var endTime = $("#endTime").datebox("getValue");
        var machineCode = $("#machineCode").combobox("getValue");
        var errorConfirm = $("#errorConfirm").combobox("getValue");
        if (beginTime != null && beginTime != "" && beginTime.length > 0) {
            qryParam.search_beginTime = beginTime;
        }
        if (endTime != null && endTime != "" && endTime.length > 0) {
            qryParam.search_endTime = endTime;
        }
        if (machineCode != null && machineCode != "" && machineCode.length > 0) {
            qryParam.search_machineCode = machineCode;
        }
        if (errorConfirm != null && errorConfirm != "" && errorConfirm.length > 0) {
            qryParam.search_errorConfirm = errorConfirm;
        }
        return qryParam;
    }
</script>