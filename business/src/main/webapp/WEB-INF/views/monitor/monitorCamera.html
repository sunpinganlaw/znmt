<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <#include "/include/common.html"/>
    <script type="text/javascript" src="${base}/styles/js/webVideoCtrl.js"></script>
    <style type="text/css">
        html, body {
            height: 100%;
        }
        /*插件*/
        .plugin {
            width: 100%;
            height: 300px;
        }
    </style>
</head>
<body>
<div id="divPlugin" class="plugin"></div>
</body>
</html>
<script type="text/javascript">
    var g_iWndIndex = 0;
    // 获取通道
    function getChannelInfo() {
        var szIP = $("#ip", parent.document).val(),
                oSel = $("#channels", parent.document).empty(),
                nAnalogChannel = 0;

        if ("" == szIP) {
            return;
        }

        // 模拟通道
        WebVideoCtrl.I_GetAnalogChannelInfo(szIP, {
            async: false,
            success: function (xmlDoc) {
                var oChannels = $(xmlDoc).find("VideoInputChannel");
                nAnalogChannel = oChannels.length;

                $.each(oChannels, function (i) {
                    var id = parseInt($(this).find("id").eq(0).text(), 10),
                            name = $(this).find("name").eq(0).text();
                    if ("" == name) {
                        name = "Camera " + (id < 9 ? "0" + id : id);
                    }
                    oSel.append("<option value='" + id + "' bZero='false'>" + name + "</option>");
                });
                parent.showMsg(szIP + " 获取模拟通道成功！");
            },
            error: function () {
                parent.showMsg(szIP + " 获取模拟通道失败！");
            }
        });

        // 数字通道
        WebVideoCtrl.I_GetDigitalChannelInfo(szIP, {
            async: false,
            success: function (xmlDoc) {
                var oChannels = $(xmlDoc).find("InputProxyChannelStatus");

                $.each(oChannels, function (i) {
                    var id = parseInt($(this).find("id").eq(0).text(), 10),
                            name = $(this).find("name").eq(0).text(),
                            online = $(this).find("online").eq(0).text();
                    if ("false" == online) {// 过滤禁用的数字通道
                        return true;
                    }
                    if ("" == name) {
                        name = "IPCamera " + ((id - nAnalogChannel) < 9 ? "0" + (id - nAnalogChannel) : (id - nAnalogChannel));
                    }
                    oSel.append("<option value='" + id + "' bZero='false'>" + name + "</option>");
                });
//                alert(szIP + " 获取数字通道成功！");
            },
            error: function () {
//                alert(szIP + " 获取数字通道失败！");
            }
        });
        // 零通道
        WebVideoCtrl.I_GetZeroChannelInfo(szIP, {
            async: false,
            success: function (xmlDoc) {
                var oChannels = $(xmlDoc).find("ZeroVideoChannel");

                $.each(oChannels, function (i) {
                    var id = parseInt($(this).find("id").eq(0).text(), 10),
                            name = $(this).find("name").eq(0).text();
                    if ("" == name) {
                        name = "Zero Channel " + (id < 9 ? "0" + id : id);
                    }
                    if ("true" == $(this).find("enabled").eq(0).text()) {// 过滤禁用的零通道
                        oSel.append("<option value='" + id + "' bZero='true'>" + name + "</option>");
                    }
                });
//                alert(szIP + " 获取零通道成功！");
            },
            error: function () {
//                alert(szIP + " 获取零通道失败！");
            }
        });

    }

    // 窗口分割数
    function changeWndNum(iType) {
        iType = parseInt(iType, 10);
        WebVideoCtrl.I_ChangeWndNum(iType);
    }

    // 登录
    function clickLogin() {
        var szIP = $("#loginip", parent.document).val(),
                szPort = $("#port", parent.document).val(),
                szUsername = $("#username", parent.document).val(),
                szPassword = $("#password", parent.document).val();
        if ("" == szIP || "" == szPort) {
            return;
        }
        var iRet = WebVideoCtrl.I_Login(szIP, 1, szPort, szUsername, szPassword, {
            success: function (xmlDoc) {
                parent.showMsg("提示", "登陆成功");
                $("#ip", parent.document).prepend("<option value='" + szIP + "'>" + szIP + "</option>");

                getChannelInfo();

                setTimeout(function () {
                    $("#ip", parent.document).val(szIP);
                    clickStartRealPlay();
                }, 1000);
            },
            error: function () {
                parent.showMsg("提示", szIP + " 登录失败！");
//                alert(szIP + " 登录失败！");
            }
        });
        if (-1 == iRet) {
//            alert(szIP + " 已登录过！");
            parent.showMsg("提示", szIP + " 已登录过！");
        }
    }

    // 退出
    function clickLogout() {
        var szIP = $("#ip", parent.document).val(),
                szInfo = "";
        if (szIP == "") {
            return;
        }
        var iRet = WebVideoCtrl.I_Logout(szIP);
        if (0 == iRet) {
            szInfo = "退出成功！";
            $("#ip option[value='" + szIP + "']", parent.document).remove();
            getChannelInfo();
        } else {
            szInfo = "退出失败！";
        }
//        alert(szIP + " " + szInfo);
        parent.showMsg("提示", szIP + " " + szInfo);
    }

    // 开始预览
    function clickStartRealPlay() {
        var oWndInfo = WebVideoCtrl.I_GetWindowStatus(g_iWndIndex),
                szIP = $("#ip", parent.document).val(),
                iStreamType = parseInt($("#streamtype", parent.document).val(), 10),
                iChannelID = parseInt($("#channelNo", parent.document).val(), 10),
                bZeroChannel = $("#channels option", parent.document).eq($("#channels", parent.document).get(0).selectedIndex).attr("bZero") == "true" ? true : false,
                szInfo = "";
        if ("" == szIP) {
            return;
        }

        if (oWndInfo != null) {// 已经在播放了，先停止
            WebVideoCtrl.I_Stop();
        }

        var iRet = WebVideoCtrl.I_StartRealPlay(szIP, {
            iStreamType: iStreamType,
            iChannelID: iChannelID,
            bZeroChannel: bZeroChannel
        });

        if (0 == iRet) {
            szInfo = "开始预览成功！";
        } else {
            szInfo = "开始预览失败！";
        }
        parent.showMsg("提示", szIP + " " + szInfo);
//        showOPInfo(szIP + " " + szInfo);
    }

    // 停止预览
    function clickStopRealPlay() {
        var oWndInfo = WebVideoCtrl.I_GetWindowStatus(g_iWndIndex),
                szInfo = "";

        if (oWndInfo != null) {
            var iRet = WebVideoCtrl.I_Stop();
            if (0 == iRet) {
                szInfo = "停止预览成功！";
            } else {
                szInfo = "停止预览失败！";
            }
//            showOPInfo(oWndInfo.szIP + " " + szInfo);
            parent.showMsg("提示", oWndInfo.szIP + " " + szInfo);
        }
    }

    // 全屏
    function clickFullScreen() {
        WebVideoCtrl.I_FullScreen(true);
    }

    //云台控制开始begin
    // PTZ控制 9为自动，1,2,3,4,5,6,7,8为方向PTZ
    var g_bPTZAuto = false;
    function mouseDownPTZControl(iPTZIndex) {
        var oWndInfo = WebVideoCtrl.I_GetWindowStatus(g_iWndIndex),
                bZeroChannel = $("#channels option",parent.document).eq($("#channels",parent.document).get(0).selectedIndex).attr("bZero") == "true" ? true : false,
                iPTZSpeed = $("#ptzspeed",parent.document).val(),
                bStop = false;

        if (bZeroChannel) {// 零通道不支持云台
            return;
        }

        if (oWndInfo != null) {
            if (9 == iPTZIndex && g_bPTZAuto) {
                iPTZSpeed = 0;// 自动开启后，速度置为0可以关闭自动
                bStop = true;
            } else {
                g_bPTZAuto = false;// 点击其他方向，自动肯定会被关闭
                bStop = false;
            }

            WebVideoCtrl.I_PTZControl(iPTZIndex, bStop, {
                iPTZSpeed: iPTZSpeed,
                success: function (xmlDoc) {
                    if (9 == iPTZIndex) {
                        g_bPTZAuto = !g_bPTZAuto;
                    }
                    parent.showMsg("提示", oWndInfo.szIP + "开启云台成功！");
                },
                error: function () {
                    parent.showMsg("提示", oWndInfo.szIP + "开启云台失败！");
                }
            });
        }
    }
    // 方向PTZ停止
    function mouseUpPTZControl() {
        var oWndInfo = WebVideoCtrl.I_GetWindowStatus(g_iWndIndex);

        if (oWndInfo != null) {
            WebVideoCtrl.I_PTZControl(1, true, {
                success: function (xmlDoc) {
                    showOPInfo(oWndInfo.szIP + " 停止云台成功！");
                    parent.showMsg("提示", oWndInfo.szIP + "停止云台成功！");
                },
                error: function () {
                    showOPInfo(oWndInfo.szIP + " 停止云台失败！");
                    parent.showMsg("提示", oWndInfo.szIP + "停止云台失败！");
                }
            });
        }
    }
    // 设置预置点
    function clickSetPreset() {
        var oWndInfo = WebVideoCtrl.I_GetWindowStatus(g_iWndIndex),
                iPresetID = parseInt($("#preset",parent.document).val(), 10);

        if (oWndInfo != null) {
            WebVideoCtrl.I_SetPreset(iPresetID, {
                success: function (xmlDoc) {
                    showOPInfo(oWndInfo.szIP + " 设置预置点成功！");
                    parent.showMsg("提示", oWndInfo.szIP + "设置预置点成功！");
                },
                error: function () {
                    showOPInfo(oWndInfo.szIP + " 设置预置点失败！");
                    parent.showMsg("提示", oWndInfo.szIP + "设置预置点失败！");
                }
            });
        }
    }

    // 调用预置点
    function clickGoPreset() {
        var oWndInfo = WebVideoCtrl.I_GetWindowStatus(g_iWndIndex),
                iPresetID = parseInt($("#preset",parent.document).val(), 10);

        if (oWndInfo != null) {
            WebVideoCtrl.I_GoPreset(iPresetID, {
                success: function (xmlDoc) {
                    parent.showMsg("提示", oWndInfo.szIP + "调用预置点成功！");
                },
                error: function () {
                    parent.showMsg("提示", oWndInfo.szIP + "调用预置点失败！");
                }
            });
        }
    }
    function PTZZoomIn() {
        var oWndInfo = WebVideoCtrl.I_GetWindowStatus(g_iWndIndex);

        if (oWndInfo != null) {
            WebVideoCtrl.I_PTZControl(10, false, {
                iWndIndex: g_iWndIndex,
                success: function (xmlDoc) {
                    parent.showMsg("提示", oWndInfo.szIP + "  调焦+成功！");
                },
                error: function () {
                    parent.showMsg("提示", oWndInfo.szIP + " 调焦+失败！");
                }
            });
        }
    }

    function PTZZoomout() {
        var oWndInfo = WebVideoCtrl.I_GetWindowStatus(g_iWndIndex);

        if (oWndInfo != null) {
            WebVideoCtrl.I_PTZControl(11, false, {
                iWndIndex: g_iWndIndex,
                success: function (xmlDoc) {
                    parent.showMsg("提示", oWndInfo.szIP + "调焦-成功！");
                },
                error: function () {
                    parent.showMsg("提示", oWndInfo.szIP + "调焦-失败！");
                }
            });
        }
    }

    function PTZZoomStop() {
        var oWndInfo = WebVideoCtrl.I_GetWindowStatus(g_iWndIndex);

        if (oWndInfo != null) {
            WebVideoCtrl.I_PTZControl(11, true, {
                iWndIndex: g_iWndIndex,
                success: function (xmlDoc) {
                    parent.showMsg("提示", oWndInfo.szIP + "调焦停止成功！");
                },
                error: function () {
                    parent.showMsg("提示", oWndInfo.szIP + "调焦停止失败！");
                }
            });
        }
    }

    function PTZFocusIn() {
        var oWndInfo = WebVideoCtrl.I_GetWindowStatus(g_iWndIndex);

        if (oWndInfo != null) {
            WebVideoCtrl.I_PTZControl(12, false, {
                iWndIndex: g_iWndIndex,
                success: function (xmlDoc) {
                    parent.showMsg("提示", oWndInfo.szIP + "聚焦+成功！");
                },
                error: function () {
                    parent.showMsg("提示", oWndInfo.szIP + "聚焦+失败！");
                }
            });
        }
    }

    function PTZFoucusOut() {
        var oWndInfo = WebVideoCtrl.I_GetWindowStatus(g_iWndIndex);

        if (oWndInfo != null) {
            WebVideoCtrl.I_PTZControl(13, false, {
                iWndIndex: g_iWndIndex,
                success: function (xmlDoc) {
                    parent.showMsg("提示", oWndInfo.szIP + "聚焦-成功！");
                },
                error: function () {
                    parent.showMsg("提示", oWndInfo.szIP + "聚焦-失败！");
                }
            });
        }
    }

    function PTZFoucusStop() {
        var oWndInfo = WebVideoCtrl.I_GetWindowStatus(g_iWndIndex);

        if (oWndInfo != null) {
            WebVideoCtrl.I_PTZControl(12, true, {
                iWndIndex: g_iWndIndex,
                success: function (xmlDoc) {
                    parent.showMsg("提示", oWndInfo.szIP + "聚焦停止成功！");
                },
                error: function () {
                    parent.showMsg("提示", oWndInfo.szIP + "聚焦停止失败！");
                }
            });
        }
    }

    function PTZIrisIn() {
        var oWndInfo = WebVideoCtrl.I_GetWindowStatus(g_iWndIndex);

        if (oWndInfo != null) {
            WebVideoCtrl.I_PTZControl(14, false, {
                iWndIndex: g_iWndIndex,
                success: function (xmlDoc) {
                    parent.showMsg("提示", oWndInfo.szIP + "光圈+成功！");
                },
                error: function () {
                    parent.showMsg("提示", oWndInfo.szIP + "光圈+失败！");
                }
            });
        }
    }

    function PTZIrisOut() {
        var oWndInfo = WebVideoCtrl.I_GetWindowStatus(g_iWndIndex);

        if (oWndInfo != null) {
            WebVideoCtrl.I_PTZControl(15, false, {
                iWndIndex: g_iWndIndex,
                success: function (xmlDoc) {
                    parent.showMsg("提示", oWndInfo.szIP + "光圈-成功！");
                },
                error: function () {
                    parent.showMsg("提示", oWndInfo.szIP + "光圈-失败！");
                }
            });
        }
    }

    function PTZIrisStop() {
        var oWndInfo = WebVideoCtrl.I_GetWindowStatus(g_iWndIndex);

        if (oWndInfo != null) {
            WebVideoCtrl.I_PTZControl(14, true, {
                iWndIndex: g_iWndIndex,
                success: function (xmlDoc) {
                    parent.showMsg("提示", oWndInfo.szIP + "光圈停止成功！");
                },
                error: function () {
                    parent.showMsg("提示", oWndInfo.szIP + "光圈停止失败！");
                }
            });
        }
    }
    //云台控制开始end

    $(function () {
        // 检查插件是否已经安装过
        if (-1 == WebVideoCtrl.I_CheckPluginInstall()) {
            alert("您还未安装过插件，双击开发包目录里的WebComponents.exe安装！");
            return;
        }
        // 初始化插件参数及插入插件
        WebVideoCtrl.I_InitPlugin(940, 510, {
            iWndowType: $("#splitWin", parent.document).val(),//窗口数
            cbSelWnd: function (xmlDoc) {
            }
        });
        WebVideoCtrl.I_InsertOBJECTPlugin("divPlugin");
        // 检查插件是否最新
        if (-1 == WebVideoCtrl.I_CheckPluginVersion()) {
            alert("检测到新的插件版本，双击开发包目录里的WebComponents.exe升级！");
            return;
        }
        parent.showMsg("提示", "摄像头控件已成功安装，可以登陆使用");
        // 窗口事件绑定
        $(window).bind({
            resize: function () {
                var $Restart = $("#restartDiv");
                if ($Restart.length > 0) {
                    var oSize = getWindowSize();
                    $Restart.css({
                        width: oSize.width + "px",
                        height: oSize.height + "px"
                    });
                }
            }
        });
        $(window.parent.document).find("#loginCamera").click();
    });
    $(window.parent.document).find("#koyoz").load(function(){
        var main = $(window.parent.document).find("#koyoz");
        var thisheight = $(document).height()+5;
        main.height(thisheight);
        main.width("99.5%");
    });
</script>