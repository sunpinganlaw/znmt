<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
    <title>计量统计报表</title>
    <base href="${base}/">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
    <meta http-equiv="description" content="this is my page">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <#include "/include/common.html"/>
    <#include "/include/exportExcel.html"/>
</head>

<body>

    <div id="tb" >
        <form id="rptFF" method="post">
            <div class="well">
                <table style="width:98%;">
                    <tr>
                        <td style="text-align: right">
                            <label for="beginTime">开始时间</label>
                            <input class="easyui-datebox" id="beginTime" style="width:145px">
                        </td>
                        <td style="text-align: right">
                            <label for="endTime">结束时间</label>
                            <input class="easyui-datebox" id="endTime" style="width:145px">
                        </td>
                        <td style="text-align: right">
                            <label for="venNo">供应商</label>
                            <input id="venNo" class="easyui-combobox" style="width:145px;"
                                   data-options="valueField:'id',textField:'name',panelHeight:'auto',url:'${base}/business/tool/getComboboxOpt/VENDOR_INFO'" />
                        </td>
<!--                        <td style="text-align: right">
                            <label for="carrierNo">运输单位</label>
                            <input id="carrierNo" class="easyui-combobox" style="width:145px;"
                                   data-options="valueField:'id',textField:'name',panelHeight:'auto',url:'${base}/business/tool/getComboboxOpt/CARRIER_INFO'" />
                        </td>-->
                        <td style="text-align: right">
                            <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-search"  onclick="qryWeightRpt()">查询</a>
                        </td>
                    </tr>

                    <tr>
                    <td style="text-align: right">
                        <label for="coalMine">煤矿</label>
                            <input id="coalMine" class="easyui-combobox" style="width:145px;"
                                   data-options="valueField:'id',textField:'name',panelHeight:'300',url:'${base}/business/tool/getComboboxOpt/COAL_MINE'" /></td>
                        <td style="text-align: right">
                            <label for="coalNo">煤种</label>
                            <input id="coalNo" class="easyui-combobox" style="width:145px;"
                                   data-options="valueField:'id',textField:'name',panelHeight:'auto',url:'${base}/business/tool/getComboboxOpt/COAL_TYPE'" />
                        </td>
                        <td style="text-align: right">
                            <label for="batchNo">批次号</label>
                            <input class="easyui-textbox" id="batchNo" style="width:145px;" value=""/>
                        </td>
                        <td style="text-align: right">
                            <label for="carId">车号</label>
                            <input class="easyui-textbox" id="carId" style="width:145px;" value=""/>
                        </td>
                        <td style="text-align: right">
                            <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-print"  onclick="printTrainsWeight()">打印计量单</a>
                            <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-excel"  onclick="qryEXL()">导出EXCEL</a>
                        </td>
                    </tr>
                </table>
            </div>
        </form>



        <table style="width:95%;">
            <tr>
                <td style="text-align: right">入厂车数</td>
                <td>
                    <input class="easyui-textbox" type="text" id="totalEntryCnt"  style="width:60px;text-align: center;" readonly="true"/>
                </td>

                <td style="text-align: right">称重车数</td>
                <td >
                    <input class="easyui-textbox" type="text" id="totalCZCnt" style="width:60px;text-align: center;" readonly="true"/>
                </td>
                <td style="text-align: right">总毛重</td>
                <td >
                    <input class="easyui-textbox" type="text" id="totalMzQty" style="width:70px;text-align: center;" readonly="true"/>
                </td>
                <td style="text-align: right">总皮重</td>
                <td >
                    <input class="easyui-textbox" type="text" id="totalPzQty" style="width:70px;text-align: center;" readonly="true"/>
                </td>
                <td style="text-align: right">总净重</td>
                <td >
                    <input class="easyui-textbox" type="text" id="totalNetQty" style="width:70px;text-align: center;" readonly="true"/>
                </td>
        </tr>
        </table>
    </div>

    <div id="tx" style="margin: 4px;width: 99%">
        <table id="dg" title="火车计量汇总与明细查询" ></table>
    </div>

    <div id="trainJLPrintWin"></div>
</body>
<script type="text/javascript">
    $dg = $("#dg");

    //输入查询条件的参数对象
    var paramObj = new Object();

    //刚进入页面时，查询日期默认取当前日的
    var myDate = new Date();
    var beginTime = myDate.getFullYear()+"-"+(parseInt(myDate.getMonth())+1)+"-"+myDate.getDate();
    var endTime =  myDate.getFullYear()+"-"+(parseInt(myDate.getMonth())+1)+"-"+myDate.getDate();
    paramObj.search_beginTime = beginTime;
    paramObj.search_endTime = endTime;

    function qryWeightRpt(){
        var paramO = new Object();

        var beginTime = $("#beginTime").datebox("getValue");
        var endTime = $("#endTime").datebox("getValue");

        var venNo = $("#venNo").combobox("getValue");
        var batchNo = $("#batchNo").textbox("getValue");
        //var carrierNo = $("#carrierNo").combobox("getValue");
        var carId = $("#carId").textbox("getValue");
        var coalNo = $("#coalNo").combobox("getValue");
        var coalMine = $("#coalMine").combobox("getValue");

        //查询条件的，都必须带上 search_ 这个前缀，才能让后台的beanUtil里捕获到这个参数并映射到entity条件里。。 xieyt
        if (beginTime != null && beginTime != "" && beginTime.length > 0) {
            paramO.search_beginTime = beginTime;
       // }else{
           // paramO.search_beginTime  = myDate.getFullYear()+"-"+(parseInt(myDate.getMonth())+1)+"-"+myDate.getDate();
        }

        if (endTime != null && endTime != "" && endTime.length > 0) {
            paramO.search_endTime = endTime;
        //}else{
          //  paramO.search_endTime =  myDate.getFullYear()+"-"+(parseInt(myDate.getMonth())+1)+"-"+myDate.getDate();
        }

        if (venNo != null && venNo != "" && venNo.length > 0) {
            paramO.search_venNo = venNo;
        }

        if (batchNo != null && batchNo != "" && batchNo.length > 0) {
            paramO.search_batchNo = batchNo;
        }

        if (carId != null && carId != "" && carId.length > 0) {
            paramO.search_carId = '%'+carId+'%';
        }

        if (coalNo != null && coalNo != "" && coalNo.length > 0) {
            paramO.search_coalNo = coalNo;
        }

        if (coalMine != null && coalMine != "" && coalMine.length > 0) {
            paramO.search_coalMine = coalMine;
        }

        $dg.datagrid('load',paramO);
        qrySummryWeightCnt(paramO);
    }

    //初始化查询报表，全量查询
    $(function () {
        $dg.datagrid({
            url: "${base}/business/report/trainWeightRptList",
            pagination: true,
            pagenumber:true,
            pageSize:100,
            pageList: [100, 150],
            //fitColumns: true,
            height: $(this).height() - 8,
            width: $(this).width() - 25,
            idField:'recordNo',
            singleSelect:true,
            rownumbers: true,
            toolbar: '#tb',
            queryParams: {//默认第一次查询是当天
                search_beginTime:beginTime,
                search_endTime:endTime
            },
            columns: [
                [
                    {field: 'batchNo', title: '批次号', width: 120, align:'center'},
                    {field: 'venNam', title: '供应商', width: 120, align:'center'},
                   // {field: 'carrierNam', title: '运输单位', width: 80, align:'center'},
                    {field: 'xhNum', title: '车厢序号', width: 70, align:'center'},
                    {field: 'carId', title: '车号', width: 70, align:'center'},
                    {field: 'coalMine', title: '煤矿', width: 100, align:'center'},
                    {field: 'coalNam', title: '煤种', width: 70, align:'center'},
                    {field: 'tickQty', title: '票重', width: 55, align:'center'},
                    {field: 'mzQty', title: '毛重', width: 55, align:'center'},
                    {field: 'pzQty', title: '皮重', width: 55, align:'center'},
                    {field: 'netQty', title: '净重', width: 55, align:'center'},
                   // {field: 'kdQty', title: '扣吨', width: 55, align:'center'},
                    {field: 'netQty', title: '验收重量', width: 55, align:'center'},
                    {field: 'ykQty', title: '盈亏', width: 55, align:'center'},
                    {field: 'recordDtm', title: '入厂时间', width: 130, align:'center'},
                    {field: 'czDtm', title: '过衡时间', width: 130, align:'center'}
                ]
            ]
        });
    });

    function qrySummryWeightCnt(obj){
        $.post("${base}/business/report/trainWeightSummaryRpt", obj, function (rsp) {
            if (rsp) {
                $("#totalEntryCnt").textbox('setValue',rsp.totalEntryCnt);
                $("#totalCZCnt").textbox('setValue',rsp.totalCZCnt);
                $("#totalMzQty").textbox('setValue',rsp.totalMzQty);
                $("#totalPzQty").textbox('setValue',rsp.totalPzQty);
                $("#totalNetQty").textbox('setValue',rsp.totalNetQty);
            } else {
                showMsg("提示", "查询称重汇总数据失败!");
            }
        }).error(function () {
            showMsg("提示", "查询称重汇总数据异常!");
         });
    }

    //刚进入页面的时候初始执行查询汇总报表
    qrySummryWeightCnt(paramObj);


    function printTrainsWeight(){
        $('#trainJLPrintWin').window({
            modal : true,
            title : "火车计量打印",
            width : 1100,
            height : 500,
            collapsible : false,
            minimizable : false,
            maximizable : true,
            href : '${base}/business/report/gotoPrintTrainsWeight'
        });
    }

    function qryEXL() {
        var venNo = $("#venNo").combobox("getValue");
        var carrierNo = $("#carrierNo").combobox("getValue");
        var coalMine = $("#coalMine").combobox("getValue");
        var coalNo = $("#coalNo").combobox("getValue");
        var batchNo = $("#batchNo").textbox("getValue");
        var carId = $("#carId").textbox("getValue");
        var beginTime = $("#beginTime").datebox("getValue");
        var endTime = $("#endTime").datebox("getValue");
        var inputObj =  {venNo:venNo,
            carrierNo:carrierNo,
            coalMine:coalMine,
            coalNo:coalNo,
            batchNo:batchNo,
            carId:carId,
            beginTime:beginTime,
            endTime:endTime};
        exportExcel($dg,"org.gxz.znrl.mapper","RptMapper","qryTrainWeightRptListCnt","qryTrainWeightRptList",inputObj,"","","");
    }
</script>
</html>
