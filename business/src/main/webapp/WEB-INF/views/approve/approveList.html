<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
    <title>待我审批</title>
    <base href="${base}/">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
    <meta http-equiv="description" content="this is my page">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <#include "/include/common.html"/>
</head>

<body>

    <div id="tb" >
        <label for="apprEventTypeCd">审批事项</label>
        <input id="apprEventTypeCd" class="easyui-combobox" style="width:145px;"
               data-options="valueField:'id',textField:'name',panelHeight:'auto',url:'${base}/business/tool/getComboboxOpt/APPR_EVENT_TYPE'" />
        <a href="javascript:void(0)" id="qryBtn" class="easyui-linkbutton" iconCls="icon-search"  onclick="qryApprList()">查询</a>
    </div>


    <div id="tx" style="margin: 4px;width: 99%">
        <table id="dg"></table>
    </div>

    <div style="margin: 4px;width: 99%">
        <table>
            <tr>
                <td>审批结果</td>
                <td><select id="isOk" name="isOk" class="easyui-combobox" data-options="panelHeight:'auto'" style="width:100px;" >
                    <option value="Y">通过</option>
                    <option value="N">不通过</option>
                </select></td>
                <td>审批意见</td>
                <td><input class="easyui-textbox"   id="apprDesc" name="apprDesc"  style="width:360px;"/>
                    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-save"  onclick="submitAppr();">提交</a></td>
            </tr>
        </table>
    </div>

    <!--详情窗口-->
    <div id="viewApprovingDetailWin" ></div>
    <input type="hidden" id="h_apprEventId">
    <input type="hidden" id="h_eventId">
</body>
<script type="text/javascript">
    $dg = $("#dg");
    var selRows;

    //查询待审批事项
    $(function () {
        $dg.datagrid({
            url: "${base}/business/approve/qryApproveList",
            fitColumns: true,
            height: $(this).height() - 100,
            width: $(this).width() - 8,
            idField:'apprId',
            singleSelect:true,
            rownumbers: true,
            toolbar: '#tb',
            columns: [
                [   {field: 'apprId', title: 'ID', width: 10, align:'center',checkbox:true},
                    {field: 'apprEventTypeName', title: '审批事项', width: 28, align:'center'},
                    {field: 'apprInitiatorName', title: '申请人', width: 28, align:'center'},
                    {field: 'apprReqDt', title: '申请时间', width: 40, align:'center'},
                    {field: 'apprContent', title: '申请事项内容描述', width: 180, align:'left'},
                    {field: '_operation', title: '操作', width: 25, align:'center',formatter:operLink}
                ]
            ]
        });
    });

    function operLink(val,row,index){
        var v = row.apprEventId;
        var cd = row.apprEventTypeCd;
        var laborCode = "-1";
        var batchType = "-1";
        //化验报告，从描述里截取下吧，也不太好取这个值
        if (cd == "5") {
            laborCode = row.apprContent.substring(5,16);
            batchType = row.apprContent.substring(26,27);
        } else if (cd == "6") {
            laborCode = row.apprContent.substring(5,13);
        }else if(cd == "9"){
            v = row.apprId;
        }
        return '<a href="javascript:void(0)" onclick="viewApprovingDetail('+cd+','+v+','+batchType+','+laborCode+')">查看详情</a>';
    }

    function viewApprovingDetail(appEventTypeCd, appEventId,batchType,laborCode){
        document.getElementById("h_apprEventId").value = appEventId;

        if (appEventTypeCd == "1" || appEventTypeCd == "2") {//气动样柜
            $('#viewApprovingDetailWin').window({
                modal : true,
                title : "查看提交审批数据详情",
                width : 1210,
                height : 400,
                collapsible : false,
                minimizable : false,
                maximizable : true,
                href : '${base}/business/monitor/viewApprovingDetail'
            });
        } else if (appEventTypeCd == "3") {//电子样柜-取样
            $('#viewApprovingDetailWin').window({
                modal : true,
                title : "查看提交审批数据详情",
                width : 1210,
                height : 400,
                collapsible : false,
                minimizable : false,
                maximizable : true,
                href : '${base}/business/monitor/viewApprovingEleSampleDetail'
            });
        } else if (appEventTypeCd == "4") {//电子样柜-清样
            $('#viewApprovingDetailWin').window({
                modal : true,
                title : "查看提交审批数据详情",
                width : 1210,
                height : 400,
                collapsible : false,
                minimizable : false,
                maximizable : true,
                href : '${base}/business/monitor/viewApprovingEleClearSampleDetail'
            });
        } else if (appEventTypeCd == "5") {//审批化验报告
            window.open( '${base}/business/labory/qryLabReportData/'+laborCode+'/99/'+batchType,
                    'newwindow',
                    'height=820,width=1200,top=0,left=0,toolbar=no,menubar=no,scrollbars=no, resizable=no,location=no, status=no');
        } else if (appEventTypeCd == "6") {//审批化验报告
            $('#viewApprovingDetailWin').window({
                modal : true,
                title : "查看提交审批数据详情",
                width : 1000,
                height : 400,
                collapsible : false,
                minimizable : false,
                maximizable : true,
                href : '${base}/business/labory/bookRptViewForApprove?standingBookId='+laborCode
            });
        } else if (appEventTypeCd == "7"||appEventTypeCd == "8") {//远光存查样柜  TODO
            $('#viewApprovingDetailWin').window({
                modal : true,
                title : "查看提交审批数据详情",
                width : 1000,
                height : 450,
                collapsible : false,
                minimizable : false,
                maximizable : true,
                href : '${base}/business/monitor/ygCabinet4ApprView'
            });
        }else if(appEventTypeCd == "9"){//查看扣吨审批详情
            document.getElementById("h_eventId").value = "viewApproveDetail";
            $('#viewApprovingDetailWin').window({
                modal : true,
                title : "扣吨提交审批详情",
                width : 500,
                height : 250,
                collapsible : false,
                minimizable : false,
                maximizable : true,
                href : '${base}/business/approve/viewKdApprDetial/'+appEventId
            });
        }else if(appEventTypeCd == "12"){//管理员账号申请 审批
            document.getElementById("h_eventId").value = "viewApproveDetail";
            $('#viewApprovingDetailWin').window({
                modal : true,
                title : "管理员账号提交审批详情",
                width : 500,
                height : 250,
                collapsible : false,
                minimizable : false,
                maximizable : true,
                href : '${base}/business/approve/viewSysUserApprDetial/'+appEventId
            });
        }
    }

    //输入查询条件的参数对象
    function qryApprList(){
        var paramO = new Object();
        var apprEventTypeCd = $("#apprEventTypeCd").combobox("getValue");

        if (apprEventTypeCd != null && apprEventTypeCd != "" && apprEventTypeCd.length > 0) {
            paramO.search_apprEventTypeCd = apprEventTypeCd;
        }

        $dg.datagrid('load',paramO);
    }


    function submitAppr(){
        selRows = $dg.datagrid('getChecked');
        var apprIdArr = [];
        if (selRows != null && selRows.length > 0) {
            for (var i=0;i<selRows.length;i++) {
                apprIdArr[i]=selRows[i].apprId;
            }
        } else {
            showMsg("提示","请先选择请求审批的记录！");
            return false;
        }

        //打开遮罩
        $.messager.progress({ msg: '正在处理，请稍候...' });

        var isOk = $("#isOk").combobox("getValue");
        var apprDesc = $("#apprDesc").textbox("getValue");

        var jsonStr = JSON.stringify(apprIdArr);
        var params = {}
        params.search_isOk = isOk;
        params.search_apprDesc = apprDesc;
        params.search_jsonStr = jsonStr;
        params.search_apprEventTypeCd =  selRows[0].apprEventTypeCd;

        var postUrl = "${base}/business/approve/saveApprResult";

        $.post(postUrl, params, function (rsp) {
            if (rsp.successful) {
                //关闭遮罩
                $.messager.progress('close');
                showMsg("提示",rsp.msg);
                $dg.datagrid('clearChecked');//必须要清理下，否则会被记录下上一次审批的id
                $dg.datagrid('reload');
            } else {
                //关闭遮罩
                $.messager.progress('close');
                $dg.datagrid('clearChecked');
                showMsg("提示", rsp.msg);
            }
        })
    }


</script>
</html>
